# 项目改进总结

## 🎯 已完成的改进模块

### 1. ✅ Flash数据持久化模块

**模块文件**:
- `Software/FlashStorage/FlashStorage.h`
- `Software/FlashStorage/FlashStorage.c`

**功能**:
- 配置参数持久化(上传间隔、使能状态等)
- 最后统计结果保存
- 历史记录管理(最多50条,循环存储)
- 数据校验和验证

**存储位置**: STM32 Flash扇区11 (0x080E0000, 64KB)

---

### 2. ✅ ASRPRO语音识别模块

**模块文件**:
- `Hardware/ASRPRO/ASRPRO.h`
- `Hardware/ASRPRO/ASRPRO.c`

**功能**:
- 语音指令接收(USART2, 9600波特率)
- 菜单导航控制(上/下/确认/返回)
- 统计控制(开始/暂停/清零/上传/报状态)

**支持的语音指令**:
| 识别词 | 功能 |
|--------|------|
| "向上" | 菜单上移 |
| "向下" | 菜单下移 |
| "确认" | 确认操作 |
| "返回" | 返回上一级 |
| "开始统计" | 开始计数 |
| "暂停统计" | 暂停计数 |
| "上传数据" | 触发数据上传 |
| "清零" | 清零统计 |
| "报状态" | 播报当前状态 |

**硬件连接**:
- ASRPRO TX → STM32 PA3 (USART2_RX)
- ASRPRO RX → STM32 PA2 (USART2_TX)

---

### 3. ✅ ESP8266命令处理模块

**模块文件**:
- `Software/ESP8266Cmd/ESP8266Cmd.h`
- `Software/ESP8266Cmd/ESP8266Cmd.c`

**功能**:
- 处理ESP8266通过CYZ格式发送的命令
- 数据上传控制
- LED远程控制
- 统计操作控制
- 状态查询

**支持的CYZ命令**:
| 命令 | 功能 |
|------|------|
| `<CYZ:Upload_on:CYZ>` | 上传统计数据 |
| `<CYZ:PC13_on:CYZ>` | 点亮LED |
| `<CYZ:PC13_off:CYZ>` | 熄灭LED |
| `<CYZ:Start_count:CYZ>` | 开始统计 |
| `<CYZ:Pause_count:CYZ>` | 暂停统计 |
| `<CYZ:Clear_count:CYZ>` | 清零统计 |
| `<CYZ:Get_status:CYZ>` | 获取状态并发送 |

---

### 4. ✅ 菜单功能扩展

**模块文件**:
- `Software/Menu/MenuFunctions_Extend.c`

**新增功能**:
- `Func_History()` - 查看历史记录(按记录ID浏览)
- `Func_AutoUpload()` - 自动上传设置(间隔时间、使能开关)
- `Func_VoiceControl()` - 语音控制演示界面

---

## 📋 集成步骤

### 步骤1: 添加文件到Keil项目

添加以下`.c`文件到Keil项目:
1. `Software/FlashStorage/FlashStorage.c`
2. `Hardware/ASRPRO/ASRPRO.c` (可选,如果使用语音识别)
3. `Software/ESP8266Cmd/ESP8266Cmd.c`
4. `Software/Menu/MenuFunctions_Extend.c`

添加必要的库文件:
- `stm32f10x_flash.c`
- `stm32f10x_bkp.c`
- `stm32f10x_pwr.c`
- `stm32f10x_rcc.c`

### 步骤2: 修改CYZ回调函数

在 `CYZ_Package.c` 中:

```c
#include "ESP8266Cmd.h"

void cyz_data_handler(const char *data)
{
    if (data == NULL) return;

    ESP8266Cmd_Process(data);  // 处理ESP8266命令

    CYZ_Receiver_Reset();
}
```

### 步骤3: 在main.c中初始化

```c
#include "FlashStorage.h"
#include "ASRPRO.h"      // 可选
#include "ESP8266Cmd.h"

int main(void)
{
    // ... 原有初始化 ...

    FlashStorage_Init();    // Flash存储
    // ASRPRO_Init();      // ASRPRO语音(可选)
    ESP8266Cmd_Init();     // ESP8266命令处理

    // ... 主循环 ...

    while (1)
    {
        CYZ_Receiver_Process();

        // 语音指令处理(可选)
        // VoiceCommand_t cmd = ASRPRO_GetCommand();
        // if (cmd != VOICE_CMD_NONE)
        //     ASRPRO_ProcessCommand(cmd);

        // ... 其他处理 ...
    }
}
```

### 步骤4: 添加新菜单项

在 `Menu_creat.c` 中添加:

```c
#include "MenuFunctions_Extend.h"

// 在View_Data子菜单中
{"History", MENU_TYPE_FUNC, 0, Func_History, NULL, 0, 0, NULL},

// 在Settings子菜单中
{"Auto_Upload", MENU_TYPE_FUNC, 0, Func_AutoUpload, NULL, 0, 0, NULL},
{"Voice_Demo", MENU_TYPE_FUNC, 0, Func_VoiceControl, NULL, 0, 0, NULL},
```

---

## 🎨 扩展后的菜单结构

```
Main Menu
├── 1.Live_Counting (实时统计)
├── 2.View_Data (数据查看)
│   ├── Last_Result (最近结果)
│   └── History (历史记录) ⭐新增
├── 3.Settings (系统设置)
│   ├── Calibration (传感器校准)
│   ├── Reset_Count (计数清零)
│   ├── Threshold (阈值设置)
│   ├── Auto_Upload (自动上传设置) ⭐新增
│   ├── Voice_Demo (语音控制演示) ⭐新增
│   └── LED (LED开关)
├── 4.Game (游戏)
│   ├── Dinosaur_jump
│   ├── Snake
│   ├── Tetris
│   └── FlappyBird
├── 5.Upload_Data (ESP8266上传)
├── 6.ADC_display
├── 7.DHT11_Read
└── 8.About
```

---

## 📡 ESP8266双向通信

### STM32 → ESP8266 (数据上传)

```c
// 统计数据上传格式
START
F:1           // 前空数
C:269         // 芯片数
T:3           // 后空数
LOSS:3        // 缺失数
ADD:2         // 多余数
Yield:98.9    // 良品率
END
```

### ESP8266 → STM32 (CYZ命令)

ESP8266发送CYZ格式命令,STM32自动处理:

```c
// 示例: ESP8266发送
<CYZ:Start_count:CYZ>

// STM32收到后自动调用
ESP8266Cmd_Process("Start_count");  // 开始统计
```

---

## 🎤 ASRPRO语音识别

### 配置ASRPRO

在天问Block或ASRPRO配置工具中设置:

| 指令ID | 识别词 | 串口输出 |
|--------|--------|----------|
| 1 | 向上 | UP\r\n |
| 2 | 向下 | DOWN\r\n |
| 3 | 确认 | CONFIRM\r\n |
| 4 | 返回 | BACK\r\n |
| 5 | 开始统计 | START\r\n |
| 6 | 暂停统计 | PAUSE\r\n |
| 7 | 上传数据 | UPLOAD\r\n |
| 8 | 清零 | CLEAR\r\n |
| 9 | 报状态 | REPORT\r\n |

**注意**: 每条指令后加 `\r\n`

### ASRPRO与STM32通信

```
用户说话 "开始统计"
    ↓
ASRPRO识别并通过USART2发送: "START\r\n"
    ↓
STM32接收并解析
    ↓
ASRPRO_ProcessCommand(VOICE_CMD_START_COUNT)
    ↓
Statistics_Resume() - 开始统计
```

---

## 💾 Flash存储使用

### 数据布局

```
扇区11 (0x080E0000 - 0x080EFFFF)
├── 0x0000: Settings_t (配置参数) - 16字节
├── 0x0400: LastResult (最后统计) - 128字节
└── 0x0800: HistoryRecords (历史记录) - 50条 × 128字节 = 6.4KB
```

### API使用

```c
// 配置参数
Settings_t settings;
FlashStorage_LoadSettings(&settings);  // 读取
settings.upload_interval = 600;
FlashStorage_SaveSettings(&settings);  // 保存

// 历史记录
FlashStorage_AddHistory(&g_statistics);  // 添加
HistoryRecord_t record;
FlashStorage_GetHistory(0, &record);    // 读取第1条
uint8_t count = FlashStorage_GetHistoryCount();  // 获取总数
FlashStorage_ClearHistory();             // 清空
```

---

## 🚀 快速开始

### 最小集成方案(不使用ASRPRO)

如果只需要Flash存储和ESP8266命令控制:

1. 添加文件:
   - `FlashStorage.c`
   - `ESP8266Cmd.c`
   - `MenuFunctions_Extend.c`

2. 修改CYZ回调函数

3. 在main.c初始化:
   ```c
   FlashStorage_Init();
   ESP8266Cmd_Init();
   ```

4. 添加菜单项:
   - History (历史记录)
   - Auto_Upload (自动上传)

### 完整集成方案(含ASRPRO)

如果需要完整的语音控制功能:

1. 添加所有文件(包括ASRPRO)

2. 配置USART2 (9600波特率)

3. 在main.c初始化:
   ```c
   FlashStorage_Init();
   ASRPRO_Init();
   ESP8266Cmd_Init();
   ```

4. 在USART2中断中处理:
   ```c
   void USART2_IRQHandler(void)
   {
       ASRPRO_ReceiveData(USART_ReceiveData(USART2));
   }
   ```

5. 在主循环中处理语音:
   ```c
   VoiceCommand_t cmd = ASRPRO_GetCommand();
   if (cmd != VOICE_CMD_NONE)
   {
       ASRPRO_ProcessCommand(cmd);
   }
   ```

6. 添加语音菜单项:
   - Voice_Demo (语音演示)

---

## 📊 资源占用

| 模块 | Flash | RAM | 说明 |
|------|-------|-----|------|
| FlashStorage | ~4KB | ~1KB | 存储于Flash扇区11 |
| ASRPRO | ~3KB | ~200B | 可选模块 |
| ESP8266Cmd | ~2KB | ~100B | 必需模块 |
| MenuFunctions_Extend | ~2KB | ~500B | 必需模块 |
| **总计(最小)** | ~8KB | ~1.6KB | 不含ASRPRO |
| **总计(完整)** | ~11KB | ~1.8KB | 含ASRPRO |

---

## ⚠️ 注意事项

1. **Flash存储**:
   - 使用扇区11,不要覆盖程序代码
   - 历史记录循环覆盖(第51条覆盖第1条)
   - 建议定期检查数据完整性

2. **ASRPRO模块**:
   - 可选模块,不使用可不集成
   - 需要USART2支持
   - 语音识别准确率取决于ASRPRO配置

3. **ESP8266命令**:
   - 必须使用CYZ格式: `<CYZ:命令:CYZ>`
   - 确保ESP8266发送格式正确
   - 命令名称区分大小写

4. **主循环处理**:
   - 务必调用 `CYZ_Receiver_Process()`
   - 使用ASRPRO时需处理语音指令

---

## 🎉 完成效果

集成后,项目将具备:

✅ **数据持久化** - 断电不丢失配置和历史记录
✅ **远程控制** - 通过ESP8266远程控制设备
✅ **语音控制** - 使用ASRPRO实现语音操作(可选)
✅ **历史查看** - 查看历史统计记录
✅ **自动上传** - 可配置自动上传间隔

---

## 📚 相关文档

- `IntegrationGuide.md` - 详细集成指南
- `Chip_Counting_System.md` - 原系统文档
- `Menu_Usage.md` - 菜单使用说明

---

**创建日期**: 2026-01-06
**作者**: 褚耀宗
**版本**: V6.2.1
