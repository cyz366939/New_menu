# 载带芯片统计系统使用说明

## 系统概述

本系统是一个基于STM32的载带芯片统计系统，通过两个对射式红外传感器检测载带行进状态，精确统计载带上的芯片数量。

## 硬件连接

根据README.txt文件：

- **PA0** (输入): 定位孔传感器 (Index Hole Sensor) - 外部中断
- **PA1** (输入): 芯片检测传感器 (Chip Presence Sensor) - 普通输入
- **PB0**: UP_KEY (上键)
- **PB1**: DOWN_KEY (下键)
- **PB10**: BACK_KEY (返回键)
- **PA2**: OK_KEY (确认键)
- **PB8**: OLED SCL
- **PB9**: OLED SDA
- **PC13**: LED指示灯

## 系统架构

### 模块结构

```
Hardware/
  ├── Sensor/          # 传感器驱动模块
  │   ├── Sensor.h
  │   └── Sensor.c
  ├── KEY/             # 按键驱动模块
  └── OLED/            # OLED显示模块

Software/
  ├── Menu/            # 菜单系统
  ├── Statistics/      # 统计数据处理
  └── Delay/           # 延时函数

User/
  ├── main.c           # 主程序
  ├── main.h           # 主程序头文件
  ├── MenuFunctions.c  # 菜单功能实现
  └── MenuFunctions.h # 菜单功能头文件
```

## 核心功能

### 1. 传感器检测逻辑

#### 工作原理

1. **定位孔检测** (PA0):
   - 配置为外部中断，下降沿触发
   - 当检测到定位孔时，触发中断

2. **芯片检测** (PA1):
   - 配置为普通输入
   - 在定位孔中断后，延时一定时间（时间窗口）读取状态

3. **检测时序**:
   ```
   定位孔信号(PA0) ──┐
                     │
                     ├─> 延时100us (去抖)
                     │
                     ├─> 延时500us (等待芯片到达检测点)
                     │
   芯片检测(PA1) ──────┴─> 读取状态 → 判断有/无芯片
   ```

#### 检测窗口时间调整

在 `Hardware/Sensor/Sensor.c` 的 `EXTI0_IRQHandler()` 函数中：

```c
Delay_us(500);  // 根据载带速度调整此值
```

**调整方法**：
- 载带速度快 → 减小延时（如300us）
- 载带速度慢 → 增大延时（如700us）
- 需要根据实际载带速度和传感器安装位置进行校准

### 2. 统计功能

系统自动统计：
- **总过孔数** (total_count): 检测到的定位孔总数
- **有芯片数** (chip_present): 检测到有芯片的坑位数
- **无芯片数** (chip_absent): 检测到无芯片的坑位数
- **良品率** (yield_rate): 有芯片数 / 总过孔数 × 100%

### 3. 菜单系统

#### 主菜单结构

```
Main Menu
├── Live Counting (实时统计)
│   └── 进入后开始计数，显示实时数据
├── View Data (数据查看)
│   ├── Last Result (最近结果)
│   └── History (历史记录)
├── Settings (系统设置)
│   ├── Calibration (传感器校准)
│   ├── Reset Count (计数清零)
│   ├── Threshold (阈值设置)
│   ├── Set Time (时间设置)
│   └── LED (LED开关，用于调试)
└── About (关于系统)
```

## 使用方法

### 1. 系统初始化

系统启动后自动初始化：
- OLED显示
- 按键扫描
- 传感器（PA0中断，PA1输入）
- 统计系统
- 菜单系统

### 2. 实时统计

1. 在主菜单选择 **"Live Counting"**
2. 按下 **OK键** 进入实时统计界面
3. 系统自动开始计数
4. 屏幕显示：
   - 第一行：状态（Counting...）
   - 第二行：总过孔数
   - 第三行：有芯片数 / 无芯片数
   - 第四行：良品率
5. 按下 **BACK键** 停止计数并返回菜单

### 3. 查看数据

1. 在主菜单选择 **"View Data"**
2. 选择 **"Last Result"** 查看最近一次统计结果
3. 按下 **BACK键** 返回

### 4. 传感器校准

1. 在主菜单选择 **"Settings"**
2. 选择 **"Calibration"**
3. 屏幕实时显示两个传感器的状态：
   - Index: HIGH/LOW (定位孔传感器)
   - Chip: HIGH/LOW (芯片检测传感器)
4. 可用于调试传感器安装和接线
5. 按下 **BACK键** 返回

### 5. 计数清零

1. 在主菜单选择 **"Settings"**
2. 选择 **"Reset Count"**
3. 所有统计数据清零

## 代码配置

### 传感器逻辑配置

在 `Hardware/Sensor/Sensor.c` 中，可以调整：

1. **触发边沿**:
   ```c
   EXTI_InitStructure.EXTI_Trigger = EXTI_Trigger_Falling;  // 下降沿
   // 或
   EXTI_InitStructure.EXTI_Trigger = EXTI_Trigger_Rising;   // 上升沿
   ```

2. **芯片检测逻辑**:
   ```c
   // 当前逻辑：高电平=有芯片，低电平=无芯片
   uint8_t chip_present = (chip_state == SENSOR_HIGH) ? CHIP_PRESENT : CHIP_ABSENT;
   
   // 如果硬件相反，可以改为：
   uint8_t chip_present = (chip_state == SENSOR_LOW) ? CHIP_PRESENT : CHIP_ABSENT;
   ```

3. **检测窗口时间**:
   ```c
   Delay_us(500);  // 根据实际载带速度调整
   ```

### 中断优先级配置

在 `Hardware/Sensor/Sensor.c` 中：

```c
NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 1;  // 抢占优先级
NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1;        // 子优先级
```

### 计数使能控制

系统通过全局变量 `g_sensor_counting_enabled` 控制计数功能：

- **使能计数**: `Sensor_EnableCounting(1);`
- **禁用计数**: `Sensor_EnableCounting(0);`

这样可以确保：
- 在实时统计模式下，传感器中断会处理计数
- 在其他菜单模式下，传感器中断不会影响菜单操作

## 松耦合设计

### 传感器与菜单系统的分离

1. **传感器模块** (`Hardware/Sensor/`):
   - 独立处理硬件信号
   - 通过全局标志控制是否计数
   - 通过回调函数通知统计模块

2. **统计模块** (`Software/Statistics/`):
   - 独立管理统计数据
   - 提供数据查询接口
   - 不依赖菜单系统

3. **菜单系统** (`Software/Menu/`):
   - 独立处理用户交互
   - 通过函数调用控制传感器和统计
   - 不直接访问硬件

### 工作流程

```
用户操作 → 菜单系统 → 调用功能函数
                              ↓
传感器中断 → 检查使能标志 → 处理芯片检测 → 更新统计数据
                              ↓
菜单显示 ← 查询统计数据 ← 统计模块
```

## 调试建议

### 1. 传感器调试

使用 **"Calibration"** 功能：
- 观察传感器状态是否正常变化
- 检查接线是否正确
- 确认传感器安装位置

### 2. 时序调试

如果计数不准确：
1. 检查检测窗口时间是否合适
2. 使用示波器观察传感器信号时序
3. 根据实际载带速度调整延时参数

### 3. 逻辑调试

如果检测结果相反：
- 修改 `Sensor.c` 中的芯片检测逻辑
- 或调整传感器安装方向

## 扩展功能

### 历史记录存储

当前历史记录功能未实现，可以扩展：
- 使用EEPROM或Flash存储历史数据
- 实现数据导出功能（通过串口）

### 阈值设置

当前阈值设置功能未实现，可以扩展：
- 设置检测窗口时间
- 设置去抖时间
- 设置良品率报警阈值

### 时间设置

当前时间设置功能未实现，可以扩展：
- 使用RTC模块
- 在状态栏显示系统时间

## 注意事项

1. **中断优先级**: 确保传感器中断优先级设置合理，不影响菜单响应
2. **延时精度**: 检测窗口时间需要根据实际载带速度精确调整
3. **去抖处理**: 如果传感器信号有抖动，需要调整去抖时间
4. **数据保护**: 统计数据在中断中更新，确保数据一致性
5. **显示刷新**: 实时统计界面需要定期刷新，避免显示卡顿

## 故障排除

### 问题1: 计数不准确
- **原因**: 检测窗口时间不合适
- **解决**: 调整 `Delay_us()` 参数

### 问题2: 传感器无响应
- **原因**: 接线错误或传感器故障
- **解决**: 使用校准功能检查传感器状态

### 问题3: 菜单卡顿
- **原因**: 中断处理时间过长
- **解决**: 优化中断处理函数，减少延时时间

### 问题4: 数据丢失
- **原因**: 中断冲突或数据竞争
- **解决**: 检查中断优先级，确保数据访问安全

