# 载带芯片详细统计说明

## 统计项目说明

系统现在支持以下详细统计：

### 1. 基础统计
- **总过孔数** (total_count): 检测到的定位孔总数
- **有芯片数** (chip_present): 全局有芯片的坑位数
- **无芯片数** (chip_absent): 全局无芯片的坑位数
- **良品率** (yield_rate): 中间阶段良品率 = 中间芯片数 / (中间芯片数 + 中间缺失数) × 100%

### 2. 详细统计
- **前导空数** (lead_empty_count): 载带开始时的空坑位数
- **中间芯片数** (middle_chip_count): 中间阶段的正常芯片数
- **后导空数** (trail_empty_count): 载带结束时的空坑位数
- **中间缺失数** (middle_missing_count): 中间阶段应该有芯片但缺失的数量
- **不合理芯片数** (invalid_chip_count): 前后空阶段出现的芯片数量

## 载带阶段判断逻辑

### 阶段定义

系统使用状态机来跟踪载带的三个阶段：

1. **前导空阶段** (TAPE_STAGE_LEAD_EMPTY)
   - 初始状态
   - 连续的空坑位
   - 当检测到第一个芯片时，进入中间阶段

2. **中间芯片阶段** (TAPE_STAGE_MIDDLE)
   - 检测到第一个芯片后进入
   - 应该都是芯片
   - 如果连续检测到一定数量的空坑位（默认5个），认为进入后导空阶段

3. **后导空阶段** (TAPE_STAGE_TRAIL_EMPTY)
   - 连续空坑位超过阈值后进入
   - 如果检测到芯片，重新回到中间阶段（并标记为不合理芯片）

### 判断规则

#### 前导空 → 中间阶段
- **触发条件**: 检测到第一个芯片
- **处理**: 
  - 第一个芯片正常计入中间芯片数
  - 进入中间阶段

#### 中间阶段 → 后导空阶段
- **触发条件**: 连续空坑位数量 ≥ 阈值（默认5个）
- **处理**:
  - 将最后几个空坑位从中间缺失数转为后导空数
  - 进入后导空阶段

#### 后导空阶段 → 中间阶段
- **触发条件**: 检测到芯片
- **处理**:
  - 该芯片标记为不合理芯片
  - 重新进入中间阶段

## 统计逻辑说明

### 前导空阶段
- **空坑位**: 计入 `lead_empty_count`
- **芯片**: 
  - 如果是第一个芯片：正常进入中间阶段，计入 `middle_chip_count`
  - 如果已有前导空：标记为不合理芯片，计入 `invalid_chip_count`，进入中间阶段

### 中间阶段
- **芯片**: 计入 `middle_chip_count`
- **空坑位**: 
  - 计入 `middle_missing_count`
  - 如果连续空坑位达到阈值，进入后导空阶段

### 后导空阶段
- **空坑位**: 计入 `trail_empty_count`
- **芯片**: 
  - 标记为不合理芯片，计入 `invalid_chip_count`
  - 重新进入中间阶段，计入 `middle_chip_count`

## 配置参数

### 后导空判断阈值

在 `Statistics.h` 中定义：
```c
#define TRAIL_EMPTY_THRESHOLD  5   // 连续5个空坑位认为进入后导空
```

可以通过函数动态调整：
```c
Statistics_SetTrailEmptyThreshold(10);  // 设置为10个连续空坑位
```

## 显示界面

### 实时统计界面

分3页显示，可通过UP/DOWN键切换：

**页面1 - 基础统计**:
- Total: 总过孔数
- OK/NG: 有芯片数/无芯片数
- Yield: 良品率

**页面2 - 详细统计**:
- Lead: 前导空数
- Middle: 中间芯片数
- Trail: 后导空数

**页面3 - 异常统计**:
- Missing: 中间缺失数
- Invalid: 不合理芯片数
- Yield: 良品率

### 数据查看界面

同样分3页显示，可通过UP/DOWN键切换，显示最近一次统计结果。

## 良品率计算

良品率基于中间阶段的统计：
```
良品率 = 中间芯片数 / (中间芯片数 + 中间缺失数) × 100%
```

这样计算更准确，因为：
- 前导空和后导空是载带的正常结构
- 只有中间阶段的缺失才影响良品率
- 前后空阶段的不合理芯片不影响良品率

## 使用示例

### 典型载带结构

```
前导空(5个) → 中间芯片(100个，其中2个缺失) → 后导空(3个)
```

统计结果：
- 前导空数: 5
- 中间芯片数: 98
- 中间缺失数: 2
- 后导空数: 3
- 不合理芯片数: 0
- 良品率: 98 / (98 + 2) × 100% = 98%

### 异常情况

如果后导空阶段检测到芯片：
- 该芯片计入不合理芯片数
- 系统重新进入中间阶段
- 良品率不受影响

## 注意事项

1. **阈值调整**: 根据实际载带特性调整 `TRAIL_EMPTY_THRESHOLD`
2. **第一个芯片**: 第一个芯片总是正常进入中间阶段，不计入不合理芯片
3. **阶段切换**: 阶段切换是自动的，无需手动干预
4. **数据重置**: 清零操作会重置所有统计数据，包括阶段信息

