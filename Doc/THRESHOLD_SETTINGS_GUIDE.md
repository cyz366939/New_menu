# 阈值设置功能使用指南

## 概述

本项目已实现动态阈值设置功能，允许用户在运行时调整统计参数的判断阈值，无需重新编译代码。

## 功能特性

### 可调整的阈值参数

1. **前导芯片阈值 (FrontTh)**
   - 变量名：`g_front_chip_threshold`
   - 默认值：3
   - 作用：连续检测到多少个芯片后，认为进入中间芯片阶段
   - 影响：值越大，系统越不容易误判进入芯片计数阶段

2. **中间缺失最大计数 (MidLoss)**
   - 变量名：`g_middle_loss_max`
   - 默认值：2
   - 作用：中间阶段连续缺失多少个芯片后，转为后导空阶段且不报警
   - 影响：值越大，对中间缺失的容忍度越高

3. **后导空阈值 (TrailTh)**
   - 变量名：`g_trail_empty_threshold`
   - 默认值：3
   - 作用：连续多少个空坑位后，认为进入后导空阶段
   - 影响：值越大，后导空检测越严格

## 使用方法

### 通过菜单设置

1. 在主菜单中找到 **"Threshold"** 选项并选择
2. 使用 **上下方向键** 选择要修改的参数
3. 按 **OK键** 进入编辑模式
4. 使用 **左右方向键** 调整数值（可调范围：1-10）
5. 按 **OK键** 保存修改，或按 **BACK键** 取消修改
6. 按 **BACK键** 退出阈值设置界面

### 菜单界面说明

```
Threshold Settings
> 1.FrontTh:3
  2.MidLoss:2
  3.TrailTh:3
  BACK
OK:Edit  BACK:Exit
```

- `>` 表示当前选中的菜单项
- 编辑模式下会显示当前编辑的数值
- 操作提示显示在屏幕底部

## 技术实现

### 文件修改记录

#### 1. Statistics.h
- 添加了阈值默认值宏定义
- 声明了全局阈值变量（extern）

#### 2. Statistics.c  
- 定义了全局阈值变量
- 修改了统计逻辑，使用变量替代硬编码宏
- 移除了原有的硬编码阈值检查

#### 3. MenuFunctions.c
- 实现了完整的阈值设置交互界面
- 支持实时预览和修改阈值
- 集成到现有菜单系统中

### 代码结构

```c
// 阈值默认值
#define FRONT_CHIP_THRESHOLD_DEFAULT   3
#define MIDDLE_LOSS_MAX_DEFAULT        2  
#define TRAIL_EMPTY_THRESHOLD_DEFAULT  3

// 全局阈值变量（可在运行时修改）
extern uint32_t g_front_chip_threshold;
extern uint32_t g_middle_loss_max;
extern uint32_t g_trail_empty_threshold;
```

## 应用场景

### 1. 不同载带规格适配
- **高密度载带**：可适当提高阈值，避免误判
- **低密度载带**：可降低阈值，提高检测灵敏度

### 2. 生产环境优化
- **高良品率产品**：可提高中间缺失容忍度
- **精密器件**：可降低阈值，严格检测

### 3. 故障排查
- 当出现频繁误报时，可临时调整阈值观察效果
- 统计异常时可回溯阈值设置历史

## 注意事项

1. **数值范围**：建议设置在1-10之间，过大可能影响检测准确性
2. **实时生效**：阈值修改后立即生效，无需重启系统
3. **持久化**：当前版本阈值修改仅在内存中生效，重启后恢复默认值
4. **配合校准**：修改阈值后建议进行传感器校准以确保最佳效果

## 故障排除

### 问题1：无法进入阈值设置
- 检查菜单中是否存在"Threshold"选项
- 确认菜单系统正常加载

### 问题2：修改后无效果
- 检查统计逻辑是否正确使用变量
- 确认没有其他地方的硬编码覆盖

### 问题3：数值显示异常
- 重启系统恢复默认设置
- 检查OLED显示驱动是否正常

## 后续改进计划

1. **EEPROM存储**：添加阈值设置的掉电保存功能
2. **参数校验**：增加更严格的数值范围检查
3. **批量设置**：支持一键恢复默认或应用预设方案
4. **实时监控**：显示阈值对统计结果的实时影响
5. **权限管理**：区分操作员和管理员的设置权限

## 版本历史

- **v1.0** (2025-12-26)：初始版本，实现基本阈值设置功能
  - 支持3个核心阈值的动态调整
  - 完整的菜单交互界面
  - 实时生效，无需重启

---

**技术支持**：如在使用过程中遇到问题，请参考项目文档或联系开发团队。